generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENTE
  EMPLEADO
  PROVEEDOR
}

enum OrderStatus {
  BORRADOR
  PENDIENTE_VALIDACION
  VALIDADO
  COMPLETADO
  RECHAZADO
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         UserRole
  name         String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  productsSupplied Product[]           @relation("SupplierProducts")
  orders           Order[]             @relation("CustomerOrders")
  consolidated     ConsolidatedOrder[] @relation("ProviderConsolidatedOrders")
}

model Product {
  id        String  @id @default(uuid())
  sku       String  @unique
  name      String
  basePrice Decimal @db.Decimal(12, 2)
  stock     Int     @default(0)

  providerId String
  provider   User   @relation("SupplierProducts", fields: [providerId], references: [id])

  pricingRules VolumeDiscountRule[]

  orderItems             OrderItem[]
  consolidatedOrderItems ConsolidatedOrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([providerId])
}

model VolumeDiscountRule {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  minQty     Int
  percentOff Int // 0..100

  createdAt DateTime @default(now())

  @@unique([productId, minQty])
  @@index([productId])
}

model Order {
  id         String @id @default(uuid())
  customerId String
  customer   User   @relation("CustomerOrders", fields: [customerId], references: [id])

  status OrderStatus @default(BORRADOR)

  currency String  @default("USD")
  subtotal Decimal @default(0) @db.Decimal(12, 2)
  discount Decimal @default(0) @db.Decimal(12, 2)
  total    Decimal @default(0) @db.Decimal(12, 2)

  consolidatedAt DateTime?

  items     OrderItem[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([customerId, status])
  @@index([status])
}

model OrderItem {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  qty       Int
  unitPrice Decimal @db.Decimal(12, 2)
  lineTotal Decimal @db.Decimal(12, 2)

  @@unique([orderId, productId])
  @@index([orderId])
  @@index([productId])
}

model ConsolidatedOrder {
  id         String @id @default(uuid())
  providerId String
  provider   User   @relation("ProviderConsolidatedOrders", fields: [providerId], references: [id])

  createdAt DateTime @default(now())

  items ConsolidatedOrderItem[]

  @@index([providerId])
}

model ConsolidatedOrderItem {
  id                  String            @id @default(uuid())
  consolidatedOrderId String
  consolidatedOrder   ConsolidatedOrder @relation(fields: [consolidatedOrderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  totalQty  Int
  unitPrice Decimal @db.Decimal(12, 2)
  lineTotal Decimal @db.Decimal(12, 2)

  @@unique([consolidatedOrderId, productId])
}
